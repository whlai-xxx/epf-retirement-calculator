<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malaysia EPF Retirement Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 5px;
        }
        .creator-info {
            text-align: center;
            margin-bottom: 25px;
            color: #666;
            font-size: 0.9em;
            line-height: 1.4; /* Added for line spacing */
        }
        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .input-group label {
            flex: 1;
            margin-right: 10px;
            font-weight: bold;
            text-align: left;
            display: flex; /* For inline icon and text */
            align-items: center; /* For inline icon and text */
        }
        .input-group input {
            flex: 0.8;
            max-width: 180px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px; /* Corrected typo: Changed from 4 to 4px */
            box-sizing: border-box;
            background-color: white;
            text-align: center; /* Added for center alignment */
        }
        .input-group input.empty-field {
            background-color: #ffe6e6;
            border-color: red;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 0; 
        }
        .form-row .input-group {
            flex: 0 0 calc(50% - 10px);
            margin-bottom: 15px;
        }
        @media (max-width: 768px) {
            .form-row .input-group {
                flex: 0 0 100%;
            }
        }
        button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        #calculateButton { 
            background-color: #28a745;
            width: 30%;
            margin: 20px auto 0 auto;
        }
        #calculateButton:hover {
            background-color: #218838;
        }

        #results {
            margin-top: 40px;
            padding-top: 20px;
        }
        #results h2 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            text-align: center;
        }
        table thead tr {
            background-color: #007bff;
            color: white;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        table th, table td {
            padding: 12px 15px;
            border: 1px solid #ddd;
        }
        table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }
        table tbody tr:hover {
            background-color: #e2e2e2;
        }
        .currency {
            text-align: center;
        }
        .positive-saving {
            color: green;
            font-weight: bold;
        }
        .negative-saving {
            color: red;
            font-weight: bold;
        }
        .zero-saving {
            color: red;
            font-weight: bold;
        }
        .withdrawal-zero {
            color: green;
            font-weight: bold;
        }
        .withdrawal-positive {
            color: red;
            font-weight: bold;
        }

        #chart-section {
            padding-top: 20px;
            text-align: center;
            flex-grow: 1; /* Allow chart section to take available space */
        }
        #chart-section h2 {
            color: #0056b3;
            margin-bottom: 20px;
        }
        .chart-container-wrapper { /* New wrapper for individual chart containers */
            position: relative;
            width: 100%; /* Take full width of its flex parent */
            height: 400px;
            margin-bottom: 40px; /* Increased space below each chart wrapper */
        }
        .chart-container-wrapper canvas {
            display: block; /* Ensure canvas takes full space */
        }
        /* Styles for the new chart toggle buttons */
        .chart-toggle-group {
            display: flex; /* Makes buttons sit side-by-side */
            justify-content: center; /* Centers the button group */
            margin-bottom: 20px; /* Space below the toggle */
        }

        .chart-toggle-group button {
            flex: 1; /* This will make both buttons take equal width */
            max-width: 200px; /* Optional: Limit max width for very wide screens */
            padding: 10px 20px;
            border: 1px solid #007bff;
            background-color: #f0f8ff; /* Light background for inactive */
            color: #007bff;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            width: auto; /* Override default button width */
            display: inline-block; /* Allow buttons to sit next to each other */
            margin: 0; /* Reset margins */
            border-radius: 0; /* Remove individual button radius for segmented look */
            text-align: center; /* Ensure text is centered within the button */
        }

        .chart-toggle-group button:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }

        .chart-toggle-group button:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            border-left: none; /* Merge borders */
        }

        .chart-toggle-group button.active {
            background-color: #007bff; /* Darker background for active */
            color: white;
        }

        .chart-toggle-group button:hover:not(.active) {
            background-color: #e6f2ff; /* Lighter hover for inactive */
        }

        /* Tooltip styles */
        .icon-wrapper.tooltip {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-right: 5px; /* Changed to margin-right for spacing before text */
            flex-shrink: 0;
        }

        .icon-wrapper.tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
            line-height: 1.4;
        }

        .icon-wrapper.tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .icon-wrapper.tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .info-icon {
            cursor: help;
            font-size: 0.9em;
            font-weight: normal;
            color: #007bff;
            line-height: 1;
            display: block;
        }

        /* Styles for the new summary box */
        #summaryBox {
            flex: 0 0 250px; /* Narrower box for summary */
            margin-right: 30px;
            padding: 20px;
            background-color: white; /* Changed to white */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid white; /* Changed to white */
            text-align: center; /* Center align text */
            display: flex; /* Use flexbox for vertical alignment */
            flex-direction: column;
            justify-content: space-around; /* Distribute space evenly */
        }
        #summaryBox h3 {
            color: #0056b3; /* Changed to match main title */
            margin-top: 0;
            font-size: 2.2em; /* Bigger font for "Quick Insights" */
            font-weight: bold; /* Make bold */
            margin-bottom: 15px; /* Added some margin for spacing */
        }
        #summaryBox p {
            font-size: 1.4em; /* Slightly bigger font for depletion messages */
            margin-bottom: 10px;
            line-height: 1.4;
            color: black; /* Changed to black */
        }
        #summaryBox #depletionMessage span {
            font-size: 4.4em; /* Double the current setting for age number */
            color: red;
            font-weight: bold;
            display: block; /* Ensure it's on its own line */
            margin-top: 5px;
        }
        #summaryBox .life-expectancy-group {
            margin-top: 15px; /* Adjusted margin to prevent crowding */
            display: flex;
            justify-content: center; /* Center male/female text */
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            margin-bottom: 0; /* Remove bottom margin */
            flex-direction: column; /* Stack male/female vertically */
        }
        #summaryBox .life-expectancy-group p {
            font-size: 1.0em; /* Adjust font size */
            font-weight: bold;
            margin: 0 10px; /* Spacing between male/female */
        }
        #summaryBox .life-expectancy-group span {
            font-size: 1.8em; /* Bigger font for life expectancy numbers */
        }
        #summaryBox #maleLifeExpectancyValue {
            color: #007bff;
        }
        #summaryBox #femaleLifeExpectancyValue {
            color: #d63384;
        }

        /* Flex container for summary box and chart section */
        .summary-chart-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch; /* Stretch children to match height */
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Malaysia EPF Retirement Calculator</h1>
        <p class="creator-info">
            Created by WH Lai, 22-11-2025<br>
            The developer assumes no responsibility for any consequences of its use.
        </p>

        <div class="form-row">
            <div class="input-group">
                <label for="currentSaving">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Current EPF Balance">üí∞</span>
                        <span class="tooltiptext">Enter the total amount currently accumulated in your Employees Provident Fund (EPF) account up to the present date.</span>
                    </span>
                    Current EPF Balance (RM):
                </label>
                <input type="number" id="currentSaving" value="50000" min="0" placeholder="Please enter a value">
            </div>
            <div class="input-group">
                <label for="age">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Current Age">üéÇ</span>
                        <span class="tooltiptext">Your age in years as of today. This is the starting point for all projections.</span>
                    </span>
                    Current Age (Years):
                </label>
                <input type="number" id="age" value="30" min="18" max="99" step="1" placeholder="Please enter a value">
            </div>
        </div>

        <div class="form-row">
            <div class="input-group">
                <label for="annualSaving">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Projected Annual EPF Contribution">üíµ</span>
                        <span class="tooltiptext">The estimated total amount you (and your employer, if applicable) expect to contribute to your EPF account annually. This amount is assumed for the first year of projection.</span>
                    </span>
                    Projected Annual EPF Contribution (RM):
                </label>
                <input type="number" id="annualSaving" value="10000" min="0" placeholder="Please enter a value">
            </div>
            <div class="input-group">
                <label for="projectedContributionIncrement">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Annual EPF Contribution Growth Rate">‚ÜóÔ∏è</span>
                        <span class="tooltiptext">The percentage by which your annual EPF contributions are expected to increase each year (e.g., due to salary increments or promotion). Enter '0' if you expect no annual increase.</span>
                    </span>
                    Annual EPF Contribution Growth Rate (%):
                </label>
                <input type="number" id="projectedContributionIncrement" value="3" min="0" step="0.1" placeholder="Please enter a value">
            </div>
        </div>
        
        <div class="form-row">
            <div class="input-group">
                <label for="contributionAgeLimit">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Age to Cease EPF Contributions">üõë</span>
                        <span class="tooltiptext">The age at which you anticipate ceasing all further contributions to your EPF account. This is typically your planned retirement age or an earlier date.</span>
                    </span>
                    Age to Cease EPF Contributions (Years):
                </label>
                <input type="number" id="contributionAgeLimit" value="55" min="18" max="99" step="1" placeholder="Please enter a value">
            </div>
            <div class="input-group">
                <label for="interestRate">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Anticipated Annual EPF Dividend Rate">üìä</span>
                        <span class="tooltiptext">The average annual dividend or interest rate you expect your EPF savings to earn. Historically, this has ranged but a common assumption is between 4-6%.</span>
                    </span>
                    Anticipated Annual EPF Dividend Rate (%):
                </label>
                <input type="number" id="interestRate" value="5" min="0" step="0.1" placeholder="Please enter a value">
            </div>
        </div>

        <div class="form-row">
            <div class="input-group">
                <label for="annualWithdrawal">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Initial Annual Retirement Withdrawal">üí∏</span>
                        <span class="tooltiptext">The initial annual amount you plan to withdraw from your EPF savings during retirement, starting at your specified withdrawal age. This amount will be adjusted for inflation in subsequent years.</span>
                    </span>
                    Initial Annual Retirement Withdrawal (RM):
                </label>
                <input type="number" id="annualWithdrawal" value="5000" min="0" placeholder="Please enter a value">
            </div>
            <div class="input-group">
                <label for="initialWithdrawalAge">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Age to Initiate Annual Withdrawals">üëµ</span>
                        <span class="tooltiptext">The age at which you intend to begin making annual withdrawals from your EPF account. Please note that EPF allows withdrawals from age 55 (Account 2) and full withdrawals from age 55/60 (subject to EPF rules).</span>
                    </span>
                    Age to Initiate Annual Withdrawals (Years, ‚â•55):
                </label>
                <input type="number" id="initialWithdrawalAge" value="55" min="55" max="99" step="1" placeholder="Please enter a value">
            </div>
        </div>

        <div class="form-row">
            <div class="input-group">
                <label for="inflationRate">
                    <span class="icon-wrapper tooltip">
                        <span class="info-icon" aria-label="Info: Anticipated Annual Inflation Rate">üî•</span>
                        <span class="tooltiptext">The average annual rate at which you expect the cost of living to increase. This rate is used to adjust your annual withdrawal amount each year to maintain its purchasing power. Over the past decade (2014-2023), Malaysia's average annual inflation has typically ranged between 2.0% and 2.5%.</span>
                    </span>
                    Anticipated Annual Inflation Rate (%):
                </label>
                <input type="number" id="inflationRate" value="2" min="0" step="0.1" placeholder="Please enter a value">
            </div>
        </div>

        <button id="calculateButton" onclick="calculateEPF()">Calculate</button>

        <div class="summary-chart-container">
            <!-- New Summary Box -->
            <div id="summaryBox">
                <h3>Quick Insights</h3>
                <p id="depletionMessage">
                    <!-- Message will be inserted here -->
                </p>
                <div class="life-expectancy-group">
                    <p style="margin-bottom: 5px;">Average Malaysian Life Expectancy:</p>
                    <p>Male: <span id="maleLifeExpectancyValue">72.9</span> yrs</p>
                    <p>Female: <span id="femaleLifeExpectancyValue">77.6</span> yrs</p>
                </div>
            </div>

            <div id="chart-section">
                <div class="chart-toggle-group">
                    <button id="showBalanceChart" class="active" onclick="switchChart('balance')">Year-End EPF Balance</button>
                    <button id="showDividendChart" onclick="switchChart('dividend')">Yearly EPF Dividend Earning</button>
                </div>
                
                <div id="epfBalanceChartWrapper" class="chart-container-wrapper">
                    <h2>Year-End EPF Balance Projection</h2>
                    <canvas id="epfBalanceChart"></canvas>
                </div>

                <div id="epfDividendChartWrapper" class="chart-container-wrapper" style="display:none;">
                    <h2>Yearly EPF Dividend Earning Projection</h2>
                    <canvas id="epfDividendChart"></canvas>
                </div>
            </div>
        </div>

        <div id="results">
            <h2>Retirement Projection Summary</h2>
            <div class="table-container">
                <table id="epfTable">
                    <thead>
                        <tr>
                            <th>Current Age</th>
                            <th>Starting EPF Balance (RM)</th>
                            <th>Annual EPF Contribution (RM)</th>
                            <th>Annual EPF Dividend Rate (%)</th>
                            <th>Yearly EPF Dividend Earning (RM)</th>
                            <th>Inflation-Adjusted Annual Withdrawal (RM)</th>
                            <th>Year-End EPF Balance (RM)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Results will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let epfBalanceChart;
        let epfDividendChart;
        let currentChart = 'balance'; // Track which chart is currently displayed

        // This array will store the color decision for each year,
        // which will be used by both charts.
        let yearColors = []; 

        function validateInput(inputElement) {
            if (inputElement.value === '' || isNaN(parseFloat(inputElement.value))) {
                inputElement.classList.add('empty-field');
                inputElement.placeholder = "Please enter a value";
                return false;
            } else {
                inputElement.classList.remove('empty-field');
                inputElement.placeholder = "";
                return true;
            }
        }

        function calculateEPF() {
            const inputIds = [
                'currentSaving', 'age', 'annualSaving', 'projectedContributionIncrement',
                'contributionAgeLimit', 'interestRate', 'inflationRate', 'annualWithdrawal',
                'initialWithdrawalAge'
            ];
            let allInputsValid = true;
            let emptyFields = [];
            let decimalAgeFields = [];

            inputIds.forEach(id => {
                const inputElement = document.getElementById(id);
                if (!validateInput(inputElement)) {
                    allInputsValid = false;
                    let labelNode = document.querySelector(`label[for="${id}"]`);
                    let labelText = Array.from(labelNode.childNodes)
                                         .filter(node => node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '')
                                         .map(node => node.textContent.trim())
                                         .join(' ');
                    if (labelText.endsWith(':')) labelText = labelText.slice(0, -1);
                    emptyFields.push(labelText);
                } else {
                    if (['age', 'contributionAgeLimit', 'initialWithdrawalAge'].includes(id)) {
                        if (parseFloat(inputElement.value) !== parseInt(inputElement.value)) {
                            decimalAgeFields.push(document.querySelector(`label[for="${id}"]`).textContent.replace(':', '').trim());
                            inputElement.classList.add('empty-field');
                            allInputsValid = false;
                        }
                    }
                }
            });

            if (emptyFields.length > 0) {
                alert('Please fill in the following fields:\n' + emptyFields.join('\n'));
                return;
            }

            if (decimalAgeFields.length > 0) {
                alert('Please enter whole numbers for the following age fields:\n' + decimalAgeFields.join('\n'));
                return;
            }

            let currentAge = parseInt(document.getElementById('age').value);
            let contributionAgeLimit = parseInt(document.getElementById('contributionAgeLimit').value);
            let initialWithdrawalAge = parseInt(document.getElementById('initialWithdrawalAge').value);
            
            if (contributionAgeLimit < currentAge) {
                alert('Age to Cease EPF Contributions must be greater than or equal to Current Age.');
                document.getElementById('contributionAgeLimit').classList.add('empty-field');
                document.getElementById('contributionAgeLimit').focus();
                return;
            } else {
                document.getElementById('contributionAgeLimit').classList.remove('empty-field');
            }

            if (initialWithdrawalAge < 55) {
                alert('Age to Initiate Annual Withdrawals must be 55 or greater.');
                document.getElementById('initialWithdrawalAge').classList.add('empty-field');
                document.getElementById('initialWithdrawalAge').focus();
                return;
            } else if (initialWithdrawalAge < currentAge) {
                 alert('Age to Initiate Annual Withdrawals cannot be less than your Current Age.');
                document.getElementById('initialWithdrawalAge').classList.add('empty-field');
                document.getElementById('initialWithdrawalAge').focus();
                return;
            } else {
                document.getElementById('initialWithdrawalAge').classList.remove('empty-field');
            }

            let initialAge = currentAge; 
            let currentAnnualSaving = parseFloat(document.getElementById('annualSaving').value);
            let projectedContributionIncrementRate = parseFloat(document.getElementById('projectedContributionIncrement').value) / 100;
            let interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            let inflationRate = parseFloat(document.getElementById('inflationRate').value) / 100;
            let initialAnnualWithdrawal = parseFloat(document.getElementById('annualWithdrawal').value);

            const tableBody = document.querySelector('#epfTable tbody');
            tableBody.innerHTML = '';

            let projectedSaving = parseFloat(document.getElementById('currentSaving').value);

            const ages = [];
            const savings = []; 
            const dividendEarnings = [];
            yearColors = []; // Reset yearColors for each calculation

            let annualWithdrawalAdjustedForInflation = initialAnnualWithdrawal; 
            let withdrawalStarted = false;

            let previousYearEndSaving = projectedSaving; 

            let depletionAge = -1; // -1 indicates no depletion

            for (let i = initialAge; i <= 100; i++) {
                let yearStartSaving = projectedSaving;
                let annualContributionForThisYear = 0;

                if (i < contributionAgeLimit) {
                    annualContributionForThisYear = currentAnnualSaving;
                    currentAnnualSaving *= (1 + projectedContributionIncrementRate); 
                } else {
                    annualContributionForThisYear = 0;
                    currentAnnualSaving = 0;
                }

                let savingBeforeInterest = yearStartSaving + annualContributionForThisYear;
                let interestEarned = savingBeforeInterest * interestRate;
                let savingAfterInterest = savingBeforeInterest + interestEarned;

                let actualWithdrawalThisYear = 0;

                if (i >= initialWithdrawalAge) {
                    if (!withdrawalStarted) {
                        actualWithdrawalThisYear = initialAnnualWithdrawal;
                        annualWithdrawalAdjustedForInflation = initialAnnualWithdrawal; 
                        withdrawalStarted = true;
                    } else {
                        annualWithdrawalAdjustedForInflation = annualWithdrawalAdjustedForInflation * (1 + inflationRate);
                        actualWithdrawalThisYear = annualWithdrawalAdjustedForInflation;
                    }

                    if (savingAfterInterest < actualWithdrawalThisYear) {
                        actualWithdrawalThisYear = savingAfterInterest;
                    }
                }
                
                let yearEndEPFSaving = savingAfterInterest - actualWithdrawalThisYear;

                const row = tableBody.insertRow();
                row.insertCell().textContent = i;
                row.insertCell().textContent = yearStartSaving.toFixed(2);
                row.insertCell().textContent = annualContributionForThisYear.toFixed(2);
                row.insertCell().textContent = (interestRate * 100).toFixed(2);
                row.insertCell().textContent = interestEarned.toFixed(2);
                
                const withdrawalCell = row.insertCell();
                withdrawalCell.textContent = actualWithdrawalThisYear.toFixed(2); 
                if (actualWithdrawalThisYear > 0) {
                    withdrawalCell.classList.add('withdrawal-positive');
                } else {
                    withdrawalCell.classList.add('withdrawal-zero');
                }

                const projectedSavingCell = row.insertCell();
                projectedSavingCell.textContent = yearEndEPFSaving.toFixed(2);

                if (yearEndEPFSaving <= 0 && depletionAge === -1) { // Set depletion age at first instance of <= 0
                    depletionAge = i;
                    projectedSavingCell.classList.add('zero-saving');
                } else if (yearEndEPFSaving >= previousYearEndSaving) {
                    projectedSavingCell.classList.add('positive-saving');
                } else {
                    projectedSavingCell.classList.add('negative-saving');
                }


                ages.push(i);
                savings.push(yearEndEPFSaving); 
                dividendEarnings.push(interestEarned);

                // Determine color for the year based on year-end EPF saving trend
                if (yearEndEPFSaving < previousYearEndSaving) {
                    yearColors.push('red');
                } else {
                    yearColors.push('green');
                }
                previousYearEndSaving = yearEndEPFSaving; 

                projectedSaving = yearEndEPFSaving;
            }
            createEPFBalanceChart(ages, savings, yearColors); // Pass yearColors
            createEPFDividendChart(ages, dividendEarnings, yearColors); // Pass yearColors
            
            // Update Summary Box
            const maleLifeExpectancy = 72.9;
            const femaleLifeExpectancy = 77.6;
            
            const depletionMessageElement = document.getElementById('depletionMessage');
            if (depletionAge !== -1) {
                depletionMessageElement.innerHTML = `Your EPF savings will be fully withdrawn at the age of <span id="depletionAgeValue">${depletionAge}</span>`;
            } else {
                depletionMessageElement.innerHTML = `Your EPF savings are projected to last beyond typical life expectancy.`;
                depletionMessageElement.style.color = 'black'; // Set color to black
            }
            document.getElementById('maleLifeExpectancyValue').textContent = maleLifeExpectancy;
            document.getElementById('femaleLifeExpectancyValue').textContent = femaleLifeExpectancy;

            // Ensure the correct chart is displayed and buttons are active after recalculation
            if (currentChart === 'balance') {
                switchChart('balance');
            } else {
                switchChart('dividend');
            }
        }

        function createEPFBalanceChart(ages, savings, colors) {
            const ctx = document.getElementById('epfBalanceChart').getContext('2d');
            if (epfBalanceChart) {
                epfBalanceChart.destroy();
            }

            const overallLineColor = colors.some(color => color === 'red') ? 'red' : 'green';
            const overallFillColor = colors.some(color => color === 'red') ? 'rgba(255, 0, 0, 0.1)' : 'rgba(0, 255, 0, 0.1)';

            epfBalanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ages,
                    datasets: [
                        {
                            label: 'Year-End EPF Balance (RM)',
                            data: savings, 
                            borderColor: overallLineColor, 
                            backgroundColor: overallFillColor, 
                            fill: 'origin', 
                            tension: 0.1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Current Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Year-End EPF Balance (RM)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR' }).format(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createEPFDividendChart(ages, dividendEarnings, colors) { // Added colors parameter
            const ctx = document.getElementById('epfDividendChart').getContext('2d');
            if (epfDividendChart) {
                epfDividendChart.destroy();
            }

            // Use the same overall color logic as the balance chart
            const overallLineColor = colors.some(color => color === 'red') ? 'red' : 'green';
            const overallFillColor = colors.some(color => color === 'red') ? 'rgba(255, 0, 0, 0.1)' : 'rgba(0, 255, 0, 0.1)';

            epfDividendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ages,
                    datasets: [
                        {
                            label: 'Yearly EPF Dividend Earning (RM)',
                            data: dividendEarnings,
                            borderColor: overallLineColor, // Applied the conditional color
                            backgroundColor: overallFillColor, // Applied the conditional fill color
                            fill: 'origin', 
                            tension: 0.1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Current Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Yearly EPF Dividend Earning (RM)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR' }).format(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function switchChart(chartType) {
            const balanceChartWrapper = document.getElementById('epfBalanceChartWrapper');
            const dividendChartWrapper = document.getElementById('epfDividendChartWrapper');
            const showBalanceButton = document.getElementById('showBalanceChart');
            const showDividendButton = document.getElementById('showDividendChart');

            if (chartType === 'balance') {
                balanceChartWrapper.style.display = 'block';
                dividendChartWrapper.style.display = 'none';
                showBalanceButton.classList.add('active');
                showDividendButton.classList.remove('active');
                currentChart = 'balance';
            } else if (chartType === 'dividend') {
                balanceChartWrapper.style.display = 'none';
                dividendChartWrapper.style.display = 'block';
                showBalanceButton.classList.remove('active');
                showDividendButton.classList.add('active');
                currentChart = 'dividend';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const inputElements = document.querySelectorAll('.input-group input[type="number"]');
            inputElements.forEach(input => {
                input.addEventListener('input', () => {
                    validateInput(input);
                });
                validateInput(input);
            });

            calculateEPF(); // Initial calculation and chart rendering

            // Set initial chart display and active button
            switchChart('balance');
        });
    </script>
</body>
</html>